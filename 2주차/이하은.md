# 2장. 올림픽 통계 서비스 최적화

## 이 장에서 배울 내용

- CSS 애니메이션 최적화
- 컴포넌트 지연 로딩
- 컴포넌트 사전 로딩
- 이미지 사전 로딩

## CSS 애니메이션 최적화

### 쟁크(Jank) 현상이란?

애니메이션이 끊겨 보이는 현상. 사이트나 앱이 주사율에 맞추지 못하고 더듬거리며 요동치거나 잠시 멈춘다는 것을 사용자가 보는 것.

대중적인 `디스플레이` 주사율은 60Hz. 즉, 1초에 60장의 정지된 화면을 빠르게 보여줌.  
`브라우저`도 60FPS(Frames Per Second)으로 1초에 60장의 화면을 새로 그림.
CPU가 부족해서 1초에 30장의 화면을 그리게 된다면 쟁크 현상이 발생하게 됌.

개발자 도구 Perfomance 패널의 CPU설정을 하향하면 쟁크 현상을 더 잘 볼 수 있음.

### 브라우저 랜더링 과정

브라우저는 아래와 같은 과정을 거쳐 화면을 그림. 이런 과정을 주요 `렌더링 경로(Critical Rendering Path)`, `픽셀 파이프 라인(Pixel Pipeline)` 이라고 부름.

> DOM + CSSOM > 랜더 트리 > 레이아웃 > 페인트 > 컴포지트

#### 1. DOM + CSSOM

HTML을 브라우저가 이해할 수 있는 형태로 파싱하여, 요소간의 트리구조로 표현되어있는 `DOM(Document Object Model)`을 만듦.

CSS도 마찬가지로 `CSSOM(CSS Object Model)`이라는 트리구조를 만듦. CSSOM은 각 요소가 어떤 스타일을 포함하고 있는지에 대한 정보를 포함하고 있음.

#### 2. 랜더 트리

DOM과 CSSOM의 결합으로 생성. 랜더 트리는 화면에 표시되는 각 요소의 레이아웃을 계산하는 데 사용됌.  
참고로, display: none 은 랜더 트리에 포함되지 않고, opacity: 0, visibility: hidden은 랜더트리에 포함됌.

#### 3. 레이아웃

말 그대로 화면의 레이아웃을 잡는 과정. 화면 구성 요소의 위치나 크기를 계산하고 해당 위치에 요소를 배치함.

#### 4. 페인트

화면에 배치된 요소에 색을 채워 넣는 작업. 배경 색, 글자 색, 테두리 색 등. 이때, 브라우저는 효율적인 페인트 과정을 위해 구성요소를 여러 개의 레이어(layer)로 나눠서 작업하기도 함.

#### 5. 컴포지트 (composite)

각 레이어를 합성하는 작업. 브라우저는 화면을 그릴 떄 여러 개의 레이어로 화면을 쪼개서 그린 후 마지막에 레이어를 하나로 합성함.

### 리플로우와 리페인트

#### 리플로우

> DOM + CSSOM > 랜더 트리 > 레이아웃 > 페인트 > 컴포지트

랜더링 경로의 모든 단계를 다시 재실행 함.

#### 리페인트

> ~~DOM~~ + CSSOM > 랜더 트리 > ~~레이아웃~~ > 페인트 > 컴포지트

레이아웃을 제외한 모든 단계를 재실행 함.

#### 하드웨어 가속(GPU 가속)

CPU에서 처리해야 할 작업을 GPU에 위임하여 작업. 별도의 레이어로 분리하여 GPU로 진행됌. 레이아웃 단계와 페인트 단계를 건너뛰고 화면 스타일 변경 가능.  
ex) transform, opacity 속성

## 지연 로딩 & 사전 로딩

### 컴포넌트 지연 로딩

lazy loading, Suspence을 사용하여 컴포넌트 파일을 청크 파일로 분리하여 컴포넌트를 사용하는 시점에 불러옴. 용량이 큰 라이브러리도 분리 하면 효과적.

단점: 사용하는 시점에 불러오기 때문에 불러오는 동안 대기 시간이 발생할 수 있음.

### 컴포넌트 사전 로딩

버튼을 마우스에 올려놓거나, useEffect 마운트 시점 같은 타이밍에서 import를 하여, 유저가 사용하기 전 적절한 타이밍에 필요한 파일을 미리 불러오는 방법.

### 이미지 사전 로딩

아래와 같이 Image 객체를 사용하여 이미지를 사전 로딩을 하면, 다시 이미지를 불러올 때 브라우저의 cache를 활용하여 빠르게 불러올 수 있음.  
사전 로딩을 하는 것도 브라우저의 리소스를 사용하기 때문에 성능 문제를 일으킬 수 있어서 꼭 필요한 이미지만 적절히 사전 로딩하는 게 중요함.

```
cosnt img = new Image();
img.src = 'http:...'
```
